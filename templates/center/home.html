{% extends 'product/base.tpl' %}
{% load staticfiles %}
{% load filter %}
{% block title %}
    首页
{% endblock %}
{% block style %}
    <link rel="stylesheet" href="{% static 'css/center/dev.css' %}"/>
    <link rel="stylesheet" href="/static/css/product/bootbox.css">


    <style>
    .nav>li>a:focus, .nav>li>a:hover{
        background-color: initial;
    }
        .cnt_box p.btn {
            width: 100%;
        }
        dt {
            font-weight: initial !important;
        }

        .error {
            display: inline-block;
            padding: 0 0 0 16px;
            background: url("{% static 'image/ico_error.png' %}") left center no-repeat !important;
            color: #b40000;
            font-size: 12px;
        }

        .success {
            background: initial !important;
        }

        .sel1 {
            border: 1px solid #999;
            border-radius: 4px;
            padding: 5px;
            height: 32px;
            color: #999;
            min-width: 284px;
        }

        a {
            cursor: pointer;
        }
        .ui-submit-btn:hover{
            color: #fff;
            opacity: 0.85;
        }
        .ui-submit-btn {
            width: 295px;
            height: 55px;
            margin-top: 10px;
            font-size: 17px;

            border-radius: 8px;
            color: #fff;
            background: #ff6202;
        }

        .ui-sub-p {
            width: 100%;
            text-align: center;

        }

        .disable {
            background: #bbb;
        }
    .wrap{
        background: #fff;
    }
    .nav-current{
            text-decoration:none; border-bottom: 3px solid #ff6202;height: 35px;
        }
    .ui-sub-left{
        float: left;
        width: 49%;
        min-height: 400px;
        border: 1px solid #eee;
    }
    .wrap .cnt_box{
        margin: 0;
    }
    .ui-sub-right{

        width: 109%;
        min-height: 400px;

    }
    .sub-title{
        width: 100%;
        font-size: 25px;
        text-align: center;
    }
    .ui-edit-txt{
        border: 0!important;
    }
    .btn-edit{
        float: right;
        margin: 3px 20% 0 0;
    }
    .ui-sub-item{
        display: none;
    }
    .c2ontainer{
        margin-top: 90px;
    }
    .ui-del-item{
        width: 20px;
        margin-top: 6px;
    }
    .item-team-user{
        margin-top: 10px;
    }
    .ui-edit-disable{
        border: 0;
        background-color: #fff!important;
        box-shadow: inset 0 0px 0px rgba(0,0,0,.075);
    }
    #header{
        position: fixed !important;
        width:100% !important;
        top:0 !important;
    }
    .item-team-user1{
        height: 30px!important;
    }
    .slider-bar{
        padding-top: 3%;
    margin-left: 0px;
    width: 200px;
    /* height: 400px; */
    float: left;
    position: fixed;
    height: 100%;
    box-shadow: 3px 1px 4px rgba(0,0,0,.1);
        text-align: center;
    }
    .tab{
        display: none;
    }
    .active{
        display: block;
    }
    .cnt_box h3{
        background-color: initial;
    }
    .ulmenu1 a{
        color: #333;
    }
    a.selected{
        color: #f35019;
    }
    </style>

{% endblock %}

{% block menu %}
    {% create_menu 0 user.account_id %}
{% endblock %}

{% block content %}
    <div class="container" style="margin-top: 90px">
        <div class="menu slider-bar" >
            <ul class="ulmenu1">
                <li style="height: 50px"><a class="selected" href="#tab1">账号管理</a></li>
                <li style="height: 50px"><a href="#">团队管理</a></li>
                <li style="height: 50px"><a href="#">团队邮箱</a></li>

            </ul>


        </div>

	<div class="content" style="margin-top: 0px;margin-left: 220px">

    	{% if user.developer.developer_id %}
           {% if user.developer.developer_check_status == -1 %}

           {% else %}
               <div class="menu1 menu_tab">


			            <div id="tab1" class="tab active">
                        <!--已经审核通过，可以修改信息-->
                            <form id="form1" method="post">
                            <div class="cnt_box">
                                <h3 style="margin-top: 30px">联系人信息<button type="button" class="btn btn-default btn-edit">编辑</button></h3>
                                <dl style="margin-left: 50px;margin-top: 30px">
                                    <dt><span>*</span>联系人姓名：</dt>
                                    <dd><input type="text" name="coContactName" id="inContactName" class="txt ui-edit-txt" value="{{ user.developer.developer_realname|is_none }}"
                                                   onblur="DevAppInfo.changeButtonCSS(DevAppInfo.doVerifyMsgName(this,true,64,'联系人姓名'))"
                                                   maxlength="64">
                                            <span id="coContactNameErrorId" class="error"></span></dd>
                                    <dt><span>*</span>联系人职务：</dt>
                                    <dd><label for="inContactRole"></label><input type="text" name="coContactRole" id="inContactRole" class="txt ui-edit-txt" value="{{ user.developer.developer_job|is_none }}"
                                                   onblur="DevAppInfo.changeButtonCSS(DevAppInfo.doVerifyMsgName(this,true,64,'联系人职务'))"
                                                   maxlength="64">
                                            <span id="coContactRoleErrorId" class="error"></span></dd>
                                    <dt><span>*</span>手机：</dt>
                                    <dd><label for="inContactMobile"></label><input type="text" name="coContactMobile" id="inContactMobile" class="txt ui-edit-txt" value="{{ user.developer.developer_mobile|is_none }}"
                                                   onblur="DevAppInfo.changeButtonCSS(DevAppInfo.doVerifyMobile(this,true,11))"
                                                   maxlength="11">
                                            <span id="coContactMobileErrorId" class="error"></span></dd>
                                    <dt><span>*</span>邮箱：</dt>
                                    <dd><label for="inEmail"></label><input type="text" name="devEmail" id="inEmail" class="txt ui-edit-txt" value="{{ user.developer.developer_email|is_none }}"
                                                   onblur="DevAppInfo.changeButtonCSS(DevAppInfo.doVerifyEmail(this,true,64))"
                                                   maxlength="64">
                                            <span id="devEmailErrorId" class="error"></span></dd>
                                    <dt ><span>*</span>修改密码：</dt>
                                    <dd><label for="inEmail"></label><a href="/center/modify_pwd">修改</a>
                                        <span id="devEmailErrorId" class="error"></span></dd>
                                </dl>
                            </div>

                            <p class="ui-sub-p ui-sub-item">
                                <button type="button" id="submitBtn" class="ui-submit-btn btn" >提交</button>
                                &nbsp;&nbsp;<span id="ErrorId" style="color:red"></span>
                            </p>
                            </form>
			            </div>

			            <div id="tab2" class="tab">
                            <form id="form1" method="post">
                            <div class="cnt_box">
                            <h3 style="margin-top: 30px">公司/团队信息<button type="button" class="btn btn-default btn-edit">编辑</button></h3>
                            <dl style="margin-left: 50px;margin-top: 30px;">
                                <dt><span>*</span>公司/团队名称：</dt>
                                <dd><label for="inName"></label><input type="text" name="coName" id="inName" class="txt ui-edit-txt"
                                                                       value="{{ user.developer.developer_inc|is_none }}"
                                                                       onblur="DevAppInfo.changeButtonCSS(DevAppInfo.doVerifyMsgName(this,true,64,'公司/团队名称'));"
                                                                       maxlength="64">
                                    <span id="coNameErrorId" class="error"></span></dd>
                                <dt>公司/团队网址：</dt>
                                <dd><label for="inNetUrl"></label><input type="text" name="coNetUrl" id="inNetUrl" class="txt ui-edit-txt" value="{{ user.developer.developer_site|is_none }}"
                                           onblur="DevAppInfo.changeButtonCSS(DevAppInfo.doVerifyNetUrl(this,false,255))"
                                           maxlength="255">
                                    <span id="coNetUrlErrorId" class=""></span></dd>
                                <dt>公司/团队所在地：</dt>
                                <dd><label for="inAddress"></label><input type="text" name="coAddress" id="inAddress" class="txt ui-edit-txt" value="{{ user.developer.developer_address|is_none }}"
                                           onblur="DevAppInfo.changeButtonCSS(DevAppInfo.doVerify(this,false,255))"
                                           maxlength="255">
                                    <span id="coAddressErrorId" class=""></span></dd>
                                <dt><span>*</span>开发团队人数：</dt>
                                <dd><label for="inDevScale"></label><input type="text" name="coDevScale" id="inDevScale" value="{{ user.developer.developer_person|is_none }}" class="txt ui-edit-txt"
                                           onblur="DevAppInfo.changeButtonCSS(DevAppInfo.doVerifyMsgName(this,true,64,'开发团队人数'))"
                                           maxlength="64">
                                    <span id="coDevScaleErrorId" class="error"></span></dd>
                            </dl>

                            </div>
                            <p class="ui-sub-p ui-sub-item">
                                <button type="button" id="submitBtn" class="ui-submit-btn btn" >提交</button>
                                &nbsp;&nbsp;<span id="ErrorId" style="color:red"></span>
                            </p>
                            </form>
			            </div>


			            <div id="tab3" class="tab"  >
                             <div style="" id="item-team-control " style="margin-top: 30px" class="cnt_box">
                             <h3 style="margin-top: 30px">团队邮箱管理 &nbsp;&nbsp;&nbsp;&nbsp;<a class="btn " type="button" onclick="editTeamEmail()">编辑</a>&nbsp;&nbsp;&nbsp;&nbsp;<a class="" onclick="addTeamEmail()">添加</a></h3>
                                 <p style="margin-top: 15px;display: none">团队邮箱管理  </p>
                             {% for t in team_info %}
                                <div class="row item-team-user" style="height: 30px!important;" >
                                  <div class="col-xs-2">
                                    <input type="text" class="form-control ui-edit-disable" placeholder="姓名" value="{{ t.name }}" disabled="disabled">
                                  </div>
                                  <div class="col-xs-3">
                                    <input type="text" class="form-control ui-edit-disable" placeholder="职务" value="{{ t.job }}" disabled="disabled">
                                  </div>
                                  <div class="col-xs-4">
                                    <input type="email" class="form-control ui-edit-disable" placeholder="邮箱" value="{{ t.email }}" disabled="disabled">
                                  </div>
                                    <img class="ui-del-item" src="{% static 'image/product/delete.png' %}" alt="" style="display: none">
                                </div>
                             {% endfor %}
			            </div>
                        <div style="float: left;width: 100%;margin-top: 20px">
                            <button class="btn btn-primary item-team-user1" id="addTeamSubmit" style="display: none;">确认</button>
                        </div>
		                </div>
            {% endif %}
        {% endif %}
        </div>



    </div>
    <div class="mask" id="mask" style="display:none"></div>
    <div class="pop_win" id="pop_win" style="display:none">
        <div></div>
        <p id="urlId" style="display: none"></p>
        <p><a href="javascript:void(0)" onclick="DevAppInfo.cAlert()">确定</a></p>
    </div>
    </div>

{% endblock %}

{% block end_script %}
    <script type="text/javascript" language="JavaScript" src="{% static 'js/center/devApp.js' %}"
            charset="utf-8"></script>
    <script src="/static/js/product/bootbox.js"></script>
    <script src="/static/js/ejs.js"></script>
    <script type="text/javascript" src="/static/js/center/pc.js"></script>
    <script>
        var config = {
            url: {"team_email": "{% static 'tpl/team_email.ejs' %}"}
        };
        var length = 0;
        var user_account = "{{ user.account_id }}";
        var email = "{{ user.account_email}}";
        var phone = "{{ user.account_phone}}";
        function show_error_msg(self, id, msg) {
            if ($(self).val().length == 0) {
                $("#" + id).text(msg);

            }
            else {
                $("#" + id).text("");

            }
        }
        function addTeamEmail() {
                $(".item-team-user1").show();
                length += $(".item-team-user1").length;
                console.log(length);
                var html = new EJS({url: config.url["team_email"]}).render({"id": length, "name": "", "job": "", "email": ""});
                $("#item-team-control").append(html)

            }
        function editTeamEmail() {

            $(".item-team-user1").find("input").removeAttr('disabled').removeClass('ui-edit-disable')

            $(".ui-del-item").show();
            $(".item-team-user1").show()
        }
        $(function () {
            $(".btn-edit").click(function () {
                // 编辑
                $(".ui-sub-item").show();
                $(this).parent().parent().find('input').removeAttr('disabled').removeClass('ui-edit-txt')
            });
            $("#inFac").blur(function () {
                var fac_uid = $("#inFacUid").val();
                var fac_name = $("#inFac").val();
                if (fac_name != '' && fac_uid != '') {
                    $.post('{% url 'check_fac_uuid' %}', {'fac_name': fac_name, 'fac_uuid': fac_uid}, function (data) {
                        if (data['status'] == 'ok') {
                            $("#coFacUidErrorId").addClass('success').html('<img src="{% static 'image/sucess.png' %}">');
                            DevAppInfo.changeButtonCSS(true)
                        }
                        else {
                            $("#coFacUidErrorId").removeClass('success').text('厂家标识不正确，请核对');
                        }
                    }, 'json');
                }
            });
            $("#inFacUid").blur(function () {
                var fac_uid = $("#inFacUid").val();
                var fac_name = $("#inFac").val();
                if (fac_name == null || fac_name == '') {
                    $("#coFacErrorId").text('请输入合作厂商名称');

                }
                else {
                    $("#coFacErrorId").text('');
                    $.post('{% url 'check_fac_uuid' %}', {'fac_name': fac_name, 'fac_uuid': fac_uid}, function (data) {
                        if (data['status'] == 'ok') {
                            $("#coFacUidErrorId").addClass('success').html('<img src="{% static 'image/sucess.png' %}">');

                            DevAppInfo.changeButtonCSS(true)

                        }
                        else {
                            $("#coFacUidErrorId").removeClass('success').text('厂家标识不正确，请核对');
                        }
                    }, 'json');
                }
            });
            $("#getDevCodeId").click(function () {
                var email = $("#inEmail").val();
                if (DevAppInfo.isNomalEmail(email)) {
                    $("#devEmailErrorId").text("");
                    $("#getDevCodeId").text("正在发送");
                    $("#devCodeMsgId").html('<img src="{% static 'image/loading.gif' %}">');
                    $.post('{% url 'send_email_code' %}', {'email': email}, function (data) {
                        if (data['result'] == 'ok') {
                            bootbox.alert('验证码已发送到邮箱')
                        }
                        else {
                            bootbox.alert('验证码发送失败，确认邮箱地址是否正确')

                        }
                        $("#getDevCodeId").text("获取邮箱验证码");
                        $("#devCodeMsgId").html("");
                    }, 'json');
                }
                else {

                    $("#devEmailErrorId").text('请输入正确的邮箱地址')
                }

            });
            $("#submitBtn").click(function () {
                console.log('xxx')

                var data_obj = {
                    'user': user_account,
                    'user_from': $("#user_from").val(),
                    'coName': $("#inName").val(),
                    'coNetUrl': $("#inNetUrl").val(),
                    'coAddress': $("#inAddress").val(),
                    'coDevScale': $("#inDevScale").val(),
                    'coContactName': $("#inContactName").val(),
                    'coContactRole': $("#inContactRole").val(),
                    'coContactMobile': $("#inContactMobile").val(),
                    'coContactPhone': $("#inContactPhone").val(),
                    'coContactQq': $("#inContactQq").val(),
                    'devEmail': $("#inEmail").val(),
                    'devCode': $("#inCode").val(),
                    'factory_name': $("#inFac").val(),
                    'coFacUid': $("#inFacUid").val(),
                    'coUpdate': $("#inUpdate").val()
                };
                console.log(data_obj);
                jQuery.ajax({

                    url: location.href,
                    type: "POST",
                    data: data_obj,
                    error: function () {
                        console.log("error");
                        $("#submitBtn").text('提交');
                    },
                    beforeSend: function () {
                        $("#submitBtn").text('正在提交...');

                    },
                    success: function (response) {
                        response = jQuery.parseJSON(response);
                        if (response['status'] == 'ok') {
                            $("#submitBtn").text('提交成功...');
                            location.href="/product/list";
                        }
                        else{
                            bootbox.alert(response['msg'])
                            $("#submitBtn").text('提交');
                        }
                    }

                });

            });
            $("#item-team-control").delegate(".ui-del-item", "click", function () {
                if($(".item-team-user").length<=2){
                    return false
                }else {
                    // 页面上多余一个的team成员框才可以删除
                    $(this).parent().remove()
                }

            });
            $("#addTeamSubmit").click(function () {
                // 团队邮箱信息提交
                var data = [];
                $(".item-team-user").each(function () {

                    var input_length = $(this).find("input").length;
                    if(input_length == 3){

                        var tmp = {
                            "name": $($(this).find("input")[0]).val(),
                            "job": $($(this).find("input")[1]).val(),
                            "email": $($(this).find("input")[2]).val()
                        };
                        data.push(tmp)
                    }
                });
                var data_item = {
                    "action": "submit_email",
                    "user": user_account,
                    "team_info": JSON.stringify(data)

                };
                console.log(data_item);
                jQuery.ajax({
                    url: location.href,
                    type: "POST",
                    data: data_item,
                    error: function () {
                        console.log("error");
                        $("#addTeamSubmit").text('确认');
                    },
                    beforeSend: function () {
                        $("#addTeamSubmit").text('正在提交...');

                    },
                    success: function (response) {
                        response = jQuery.parseJSON(response);
                        console.log(response);
                        if (response['status'] == 'ok') {
                            bootbox.alert("提交成功");
                            $(".item-tmp-team").remove();
                            for(var i =0;i<data.length;i++){
                                name = data[i].name;
                                job = data[i].job;
                                email = data[i].email;
                                var html = new EJS({url: config.url["team_email"]}).render({"id": length, "name": name, "job": job, "email": email});
                                $("#item-team-control").append(html)
                            }


                        }
                        else{
                            bootbox.alert(response['msg']);

                        }
                        $("#addTeamSubmit").text('确认');
                    }

                });
            })

        });


    </script>
    {#    <script src="{% static 'js/center/product.js' %}"></script>#}
{% endblock %}