<link rel="stylesheet" href="/static/layui/css/layui.css">
<style>
    body {
        line-height: 1;
    }
    .mt20{
        overflow: visible;
    }
    .layui-form-pane .layui-form-label {
        margin-right: 11px;
    }

    .layui-form-item {
        margin-bottom: 1px;
        margin-top: 12px;
    }

    .edit-btn {
        overflow: visible !important;
        position: relative;
    }

    .add-btn {
        display: none;
        margin: 0 auto;
        font-size: 12px;
        position: absolute;
        left: 0;
        right: 0;
        bottom: -16px;
        width: 50px;
        height: 15px;
        line-height: 15px;
        color: #fff;
        background-color: #777f87;
    }

    .new-colum {
        padding-top: 10px;
        margin-bottom: 0;
    }

    .del-btn {
        float: left;
        line-height: 38px;
        display: inline-block;
        cursor: pointer;
        text-indent: initial;
    }

    .del-btn:hover {
        color: #ff0000;
    }

    .popup-open {
        font-size: 0;
    }

    .popup-open .layui-form-checkbox {
        margin: 5px 1px;
    }

    .btn-active {
        display: inline-block;
        margin-left: 7px;
        margin-bottom: 18px;
    }

    .layui-input, .layui-select, .layui-textarea {
        background-color: #fff !important;
        color: initial !important;
    }

    .layui-field-title {

        border-width: 0px 0 1px;
        padding-top: 10px;
    }

    .layui-elem-field legend {
        margin-left: 0;
        padding: 0;
        font-size: 16px;
    }

    legend {
        width: initial;
        border-bottom: 0;
    }

    .layui-form-item .layui-input-inline {
        width: 160px;
    }

    .layui-form-select dl dd.layui-this {
        background-color: #f35019;
    }

    .layui-btn-warm {
        background-color: #ff6202;

    }

    .layui-form-pane .layui-input-block {
        margin-left: 0;
    }
    .layui-form-radio>i{
        font-size: 30px;
    }
    .layui-form-radio *{
        font-size: 16px;
    }
    .layui-tab-title li{
        font-size: 16px;
    }
    .layui-form-radio > i:hover, .layui-form-radioed > i {
        color: #f35019;

    }
    .layui-tab{
        margin: 20px 0;
    }
    .layui-tab-content{
        padding: 25px 10px;
    }
    .layui-badge{
        height: 37px;
        line-height: 37px;
        margin-right: 10px;
        font-size: 14px;
        margin-bottom: 5px;

    }
    .layui-tab-title .layui-this:after{
        height: 40px;
    }
    .algorithm-tips{
        color: #2980b9;
        margin-top: 10px;
        line-height: 18px;
        display: none;
    }
    .frame-val-tips{
        padding-top: 5px;
        color: #2980b9;
        display: none;
    }
    .layui-form-pane .layui-input{
        margin-bottom: 18px;
    }
    .new-frame-item{
        float: left;
        margin-top: 15px;
    }
    .layui-form-pane .layui-form-label{
        width: 140px;
    }
    .data-content-item{
        position: relative;
    padding: 20px;
    line-height: 24px;
    word-break: break-all;
    overflow: hidden;
    font-size: 14px;
    overflow-x: hidden;
    overflow-y: auto;
    height: 160px;
    }
    .data-all-item{
        float: left;
        padding: 15px;
    }
    .data-control-item{
        float: right;
        padding: 3px 15px;
    }
    .down-control-item{
        text-align: right;
    padding: 3px 15px;
    }
    .lay-confirm{
        padding: 24px 20px 20px 55px;
    text-align: left;
        height: 90px;
    }
    .lay-confirm-icon3{
        position: absolute;
    top: 16px;
    left: 15px;

    width: 30px;
    height: 30px;
    }
    .lay-my-progress{
        margin-bottom: 35px;
        display: none;
    }
    .down-a{
        font-size: 15px;
        padding: 0 22px;
        display: none;
    }
</style>

<div style="padding: 10px 3%;min-height: 500px" ng-controller="ProtocolCtrl">

    <fieldset class="layui-elem-field layui-field-title" style="display: none">
        <legend>协议帧定义</legend>
    </fieldset>
    <div class="layui-form layui-form-pane" >
        <div class="layui-form-item" style="display: none">
            <div class="layui-input-block">
                <input type="radio" name="protocol" value="1" title="标准协议" ng-checked="!protocol_zdy" lay-filter="protocol_zdy">
                <input type="radio" name="protocol" value="2" title="自定义协议" ng-checked="protocol_zdy" lay-filter="protocol_zdy">


            </div>
        </div>

        <div class="layui-tab" lay-filter="demo">
          <ul class="layui-tab-title">
            <li class="layui-this">屏端到MCU</li>
            <li>MCU到屏端</li>
          </ul>
          <p style="color: #c1c1c1;height: 10px;top:-20px;position:relative;margin-left: 300px">屏端与MCU上下行数据域内容一样时仅需定义一次;鼠标移动到协议上可添加新协议类型。</p>
          <div class="layui-tab-content" style="display: none">
            <div class="layui-tab-item layui-show">
              1. 定义屏端到电控端（下行）通信协议;<br>
              <br>2. 鼠标移到协议上可添加新协议类型；<br><br>
                3. 数据域内容，点击编辑动态添加，上下行数据域内容不一样需要分开定义。
            </div>
            <div class="layui-tab-item">1. 定义电控端到屏端（上行）通信协议；<br><br>
                2. 电控到屏端和屏端到电控通信协议一样，可不用修改，默认一样。
            </div>

          </div>
        </div>
        <div class="layui-form-item" >
             <div class="layui-input-inline">
                <select name="quiz-endian" id="endian-type" lay-filter="endian">
                    <option value="" >请选择编码规则</option>
                    <option value="1" ng-if="protocol_endian==1" selected>大端编码</option>
                    <option value="1" ng-if="protocol_endian!=1">大端编码</option>
                    <option value="0" ng-if="protocol_endian==0" selected>小端编码</option>
                    <option value="0" ng-if="protocol_endian!=0">小端编码</option>
                </select>
            </div>
        </div>
        <!-- 标准协议-->
        <div ng-if="!protocol_zdy" class="layui-form-item ui-frame-item" ng-repeat="f in frame_data" on-finish-render-filters id="item-{[{ f.name }]}">
            <label class="layui-form-label edit-btn" >{[{ f.title }]}<p class="add-btn" >+</p></label>
            <p ng-if="f.name=='data' && protocol_zdy" class="layui-btn  edits" style="color: #F35019;background-color:white;border:solid 1px #f35019" ng-click="editData()" >编辑</p>
            <div ng-if="f.name=='data'" class="btn-active">
                <span class="layui-badge layui-bg-gray" ng-repeat="d in f.value" ng-if="d.content">{[{ d.title }]} </span>
            </div>
            <div class="layui-input-inline" ng-if="f.name=='check'">
                <label class="layui-form-label edit-btn" ng-repeat="a in Algorithm" ng-if="a.name==f.value.check_algorithm">算法({[{ a.title }]})</label>

            </div>

            <div ng-if="f.name!='data'"  class="layui-input-inline">
                <label class="layui-form-label edit-btn" >长度({[{ f.length }]}Byte)</label>

            </div>
            <div ng-if="f.name!='data' && f.name!='check'" class="layui-input-inline">
                <label class="layui-form-label edit-btn" style="overflow:hidden!important;">{[{ f.value }]}</label>


            </div>
            <div ng-if="f.name=='check'" class="layui-input-inline">
                <label class="layui-form-label edit-btn" ng-repeat="d in frame_data" ng-if="d.id==f.value.check_start" >校验开始位({[{ d.title }]})</label>

            </div>

            <div ng-if="f.name=='check'" class="layui-input-inline">
                <label class="layui-form-label edit-btn" ng-repeat="d in frame_data" ng-if="d.id==f.value.check_end" >校验结束位({[{ d.title }]})</label>

            </div>
        </div>

        <!-- 自定义协议-->
        <div ng-if="protocol_zdy" class="layui-form-item ui-frame-item" ng-repeat="f in frame_data" on-finish-render-filters id="item-{[{ f.name }]}">
            <label ng-mouseenter="editMouseOn($event)" ng-mouseleave="editMouseLeave($event)" class="layui-form-label edit-btn" >{[{ f.title }]}<p class="add-btn" ng-click="addFrameData($event)">+</p></label>
            <p ng-if="f.name=='data' && protocol_zdy" style="color: #F35019;background-color:white;border:solid 1px #f35019" class="layui-btn  edits" ng-click="editData()" >编辑</p>
            <div ng-if="f.name=='data'" class="btn-active">
                <span class="layui-badge layui-bg-gray" ng-repeat="d in f.value" ng-if="d.content">{[{ d.title }]} </span>
            </div>
            <div class="layui-input-inline" ng-if="f.name=='check'">
                <select name="quiz1" lay-filter="check-rel" id="check_algorithm">
                    <option value="" selected>选择算法</option>
                    <option ng-repeat="a in Algorithm" value="{[{ a.name }]}" ng-if="a.name==f.value.check_algorithm" selected>{[{ a.title }]}</option>
                    <option ng-repeat="a in Algorithm" value="{[{ a.name }]}" ng-if="a.name!=f.value.check_algorithm">{[{ a.title }]}</option>

                </select>
                <p class="algorithm-tips">SUM校验和取低8位</p>
            </div>

            <div ng-if="f.name!='data'"  class="layui-input-inline">
                <select name="quiz1-{[{ f.name }]}" id="frame-id-{[{ f.id }]}" lay-filter="frame-length">
                    <option value="" selected>请选择长度</option>

                    <option ng-repeat="l in frame_length" value="{[{ l }]}" ng-if="f.length==l" selected>{[{ l }]}Byte</option>
                    <option ng-repeat="l in frame_length" value="{[{ l }]}" ng-if="f.length!=l">{[{ l }]}Byte</option>

                </select>
            </div>
            <div ng-if="f.name!='data' && f.name!='check'" class="layui-input-inline">
                <input type="text" name="title-{[{ f.name }]}"  placeholder="请输入{[{ f.length }]}个字节传输值" maxlength="{[{ f.length*2 }]}" class="layui-input" value="{[{ f.value }]}" ng-keyup="valueKeyUp($event)">
                <p class="frame-val-tips">请填写{[{ f.length }]}个字节传输值</p>
            </div>
            <div class="del-btn" ng-if="f.is_enable">删除</div>
            <div ng-if="f.name=='check'" class="layui-input-inline">
                <select name="quiz-check-start" id="check_start" lay-filter="check-rel">
                    <option value="" selected>请选择校验开始位</option>
                    <option ng-repeat="d in frame_data" value="{[{ d.id }]}" ng-if="d.id==f.value.check_start" selected>{[{ d.title }]}</option>
                    <option ng-repeat="d in frame_data" value="{[{ d.id }]}" ng-if="d.id!=f.value.check_start" >{[{ d.title }]}</option>

                </select>
            </div>

            <div ng-if="f.name=='check'" class="layui-input-inline">
                <select name="quiz-check-end" id="check_end" lay-filter="check-rel">
                    <option value="" selected>请选择校验结束位</option>
                    <option ng-repeat="d in frame_data" value="{[{ d.id }]}" ng-if="d.id==f.value.check_end" selected>{[{ d.title }]}</option>
                    <option ng-repeat="d in frame_data" value="{[{ d.id }]}" ng-if="d.id!=f.value.check_end" >{[{ d.title }]}</option>
                </select>
            </div>
        </div>

    </div>
    <div class="layui-anim" >
        <button class="layui-btn layui-btn-lg layui-btn-warm" ng-click="SubmitData()" ng-if="protocol_zdy">确认</button>
    </div>

    <label class="layui-form-label" style="margin-top: 20px;background-color:white;border:solid 1px green;width: 90px">数据预览</label>
    <p ng-repeat="t in frame_data_yulan" style="display: inline-block;margin-right: 0px;padding-right: 0px;padding-left: 0px;margin-top: 20px">
            <span  class="layui-badge layui-bg-gray"  style="margin-right: 0px;padding-right: 0px;padding-left: 0px"  title="帧头" ng-if="t.name=='head' ">{[{t.value}]}</span>
            <span  class="layui-badge layui-bg-gray"  style="margin-right: 0px;padding-right: 0px;padding-left: 0px"  title="数据" ng-if="t.name!='data' && t.name!='check'&& t.name!='head'">{[{t.length}]}</span>
            <span  class="layui-badge layui-bg-gray"  style="width:auto;margin-right: 0px;padding-right: 0px;padding-left: 0px"  title="数据" ng-if="t.name=='data' &&  t.value.length>0">
                <span class="layui-badge layui-bg-gray" ng-repeat="f in t.value" style="width:auto;margin-right: 0px;padding-right: 0px;padding-left: 0px" ng-if="f.content==true && f.length=='8'" title="数据域">
                    00
                </span>
                <span class="layui-badge layui-bg-gray" ng-repeat="f in t.value" style="width:auto;margin-right: 0px;padding-right: 0px;padding-left: 0px" ng-if="f.content==true && f.length=='16'" title="数据域">
                    0000
                </span>
                <span class="layui-badge layui-bg-gray" ng-repeat="f in t.value" style="width:auto;margin-right: 0px;padding-right: 0px;padding-left: 0px" ng-if="f.content==true && f.length=='4'" title="数据域">
                    00
                </span>
                <span class="layui-badge layui-bg-gray" ng-repeat="f in t.value" style="width:auto;margin-right: 0px;padding-right: 0px;padding-left: 0px" ng-if="f.content==true && f.length=='2'" title="数据域">
                    00
                </span>
                <span class="layui-badge layui-bg-gray" ng-repeat="f in t.value" style="width:auto;margin-right: 0px;padding-right: 0px;padding-left: 0px" ng-if="f.content==true && f.length=='1'" title="数据域">
                    00
                </span>
            </span>
            <span  class="layui-badge layui-bg-gray"  style="margin-right: 0px;padding-right: 0px;padding-left: 0px"  title="校验" ng-if="t.name=='check'">{[{t.length}]}</span>

        </p>
</div>

<script src="/static/layui/layui.all.js" charset="utf-8"></script>
<script src="/static/js/ejs.js" charset="utf-8"></script>
<script>
    var config = {
        "url":{
            'frame': '/static/tpl/frame_sel.ejs'
        }
    };

    layui.use('element', function(){
          var element = layui.element;
          //一些事件监听
          element.on('tab(demo)', function(data){
               // console.log(this); //当前Tab标题所在的原始DOM元素
              console.log(data.index); //得到当前Tab的所在下标
              //console.log(data.elem); //得到当前的Tab大容器
              //通过controller来获取Angular应用
            var appElement = document.querySelector('[ng-controller=ProtocolCtrl]');
              //获取$scope变量
            var $scope = angular.element(appElement).scope();
            $scope.protocol_type = data.index;

              $scope.getFrameData(data.index, $scope.protocol_zdy)
              //$scope.$apply();
          });
        });
    layui.use('form', function(){
      var form = layui.form;

      //各种基于事件的操作，下面会有进一步介绍
        form.on('select(check-rel)', function(data){
            //通过controller来获取Angular应用
            var appElement = document.querySelector('[ng-controller=ProtocolCtrl]');
              //获取$scope变量
            var $scope = angular.element(appElement).scope();
            var dataid = data.elem.id;
          //console.log(data.elem); //得到select原始DOM对象
          //console.log(data.value); //得到被选中的值
          //console.log(data.othis); //得到美化后的DOM对象
            for (var j=0;j<$scope.frame_data.length;j++){
                if($scope.frame_data[j].name=='check'){
                    $scope.frame_data[j].value[dataid]=data.value;
                    $scope.$apply()
                }
            }
            if(data.value=='sum'){
                $(".algorithm-tips").text("Tips:将需要校验的数据累加，取低8位的一个字节").show()
                document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[4].selected=false;
                document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[3].selected=false;
                document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[2].selected=false;
                document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[1].selected=true;
                $scope.tf=document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[1].value
                layui.use('form', function () {
                    var form = layui.form;
                    form.render('select');
                });
            }
            else if(data.value=='crc16'){
                $(".algorithm-tips").text("Tips:CRC-16码由两个字节构成，是16位").show()
                $(".algorithm-tips").text("Tips:CRC-16码由两个字节构成，是16位").show()
                document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[1].selected=false;
                document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[2].selected=true;
                document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[3].selected=false;
                document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[4].selected=false;
                $scope.tf=document.getElementsByName("quiz1-check")[0].getElementsByTagName("option")[2].value
                layui.use('form', function () {
                    var form = layui.form;
                    form.render('select');
                });
            }
            else{
                $(".algorithm-tips").hide()
            }
        });
        form.on('select(frame-length)', function(data){
            //通过controller来获取Angular应用
            var appElement = document.querySelector('[ng-controller=ProtocolCtrl]');
              //获取$scope变量
            var $scope = angular.element(appElement).scope();
            var frame_id = data.elem.id.split("-")[2];
            console.log(data.elem.id);
            console.log(data.value);

            for (var j=0;j<$scope.frame_data.length;j++){
                console.log($scope.frame_data[j].id, frame_id);
                if(String($scope.frame_data[j].id) == frame_id){
                    if(data.value){
                        $scope.frame_data[j].length = parseInt(data.value);
                        $scope.$apply()
                    }
                }
            }
        });
        form.on('radio(protocol_zdy)', function(data){
         // console.log(data.elem); //得到radio原始DOM对象
         // console.log(data.value); //被点击的radio的value值
            //通过controller来获取Angular应用
            var appElement = document.querySelector('[ng-controller=ProtocolCtrl]');
              //获取$scope变量
            var $scope = angular.element(appElement).scope();
            if(data.value==2){
                // 请求自定义协议
                $scope.getFrameData(0, 1);
                $scope.protocol_zdy=1
            }
            else{
                $scope.getFrameData(0, '');
                $scope.protocol_zdy=0
            }
        });
        form.on('select(endian)', function(data){
            // 监听编码规则选择
         // console.log(data.elem); //得到radio原始DOM对象
          //console.log(data.value); //被点击的radio的value值
            //通过controller来获取Angular应用
            var appElement = document.querySelector('[ng-controller=ProtocolCtrl]');
              //获取$scope变量
            var $scope = angular.element(appElement).scope();
            $scope.protocol_endian = parseInt(data.value)
        });
        form.on('select(new_frame)', function(data){
            // 监听新建帧类型选择

            var appElement = document.querySelector('[ng-controller=ProtocolCtrl]');
            //获取$scope变量
            var $scope = angular.element(appElement).scope();
            var frame_id = data.elem.id.split("-")[2];
            var frame_ids = data.elem.id.split("-")[1];

            console.log($($(data.elem).parents()[2]).attr('id'))
            // 新增加的id
            var new_id = $($(data.elem).parents()[2]).attr('id').split("-")[1]
            console.log('id',new_id)
            console.log('fff',$scope.frame_data)
            for (var i =0,i_length=$scope.frame_data_yulan.length;i<i_length;i++){
                if($scope.frame_data_yulan[i]['name']==new_id){
                    var idss = i
                    console.log(idss,'i')
                    var yulan_id =  $scope.frame_data_yulan.length
                    var Data_dict= {"serial":"流水号","category":"数据类型","length":"帧长","response_code":"响应码","footer":"帧尾"}
                    var new_datas={"id":yulan_id+1,"name":data.value,"value":"00","title":Data_dict[data.value]}
                    console.log(new_datas)
                    //$scope.frame_data_yulan.push(new_datas)

                }
            }

            console.log('ddddd',$scope.frame_data_yulan)
            console.log('ppp',$scope.frame_data)
            if(data.value=='other'){
                var n_id = $(data.elem).attr('id').split("-")[3]; // 取到新增编号
                $("#new-frame-tmptitle-"+n_id).show();  // 自定义名称
                //$("#new-frame-bs-"+n_id).show();  // 自定义标识符
            }
        });
        form.on('select(new_frame_value)', function(data){
            // 监听新建帧类型选择
            console.log('yyy',data.value)
            // 新增加的id
            var new_id = $($(data.elem).parents()[2]).attr('id').split("-")[1]
            console.log('id',new_id)
            if(data.value=='other'){
                var n_id = $(data.elem).attr('id').split("-")[3]; // 取到新增编号
                $("#new-frame-tmptitle-"+n_id).show();  // 自定义名称
                //$("#new-frame-bs-"+n_id).show();  // 自定义标识符

            }
        });
        form.on('input(new_frame_input)', function(data){
            // 监听新建帧类型选择
            console.log('zzz',data.value)
            if(data.value=='other'){
                var n_id = $(data.elem).attr('id').split("-")[3]; // 取到新增编号
                $("#new-frame-tmptitle-"+n_id).show();  // 自定义名称
                //$("#new-frame-bs-"+n_id).show();  // 自定义标识符

            }
        });

    });
    function pinyin(item){

        var nameDish = $(item).val();
        var t_id = $(item).parent('div').attr('id').split("-")[3];
        var str = "";
        for(var i=0; i< nameDish.length; i++) {
            var nameDish2 = codefans_net_CC2PY(nameDish.charAt(i));
            str += nameDish2;
        }
        $("#new-frame-bs-"+t_id).children('input').val(str);
    }


</script>