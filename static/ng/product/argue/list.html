
<style>
        html, body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        overflow:auto;
      }

      .addButton{
            padding: 4px;
          background: #327AB7;
          color:#fff;
            font-weight: 500;
            text-decoration:none;
            cursor:pointer;
            border-radius: 4px;
      }
      .addButton:hover{
          color: #fff;
        text-decoration:none;
        cursor:pointer;
        font-weight: 800;
      }
        .ui-jqgrid tr.jqgrow td{
            position: relative;
            overflow: visible;
            white-space: normal !important;
            height:auto;
            word-break:break-all;
            line-height: 18px;
        }
        .ui-jqgrid-view>.ui-jqgrid-titlebar {
            background: #9EBEE4;
            width: 937px;
            margin-top: 20px;
            z-index: auto;
        }
        input[type=checkbox].ace.ace-switch.ace-switch-5:checked+.lbl::before {
            background-color: #337ab7;
            border-color: #337ab7;
            content: "YES \a0\a0\a0\a0\a0\a0\a0\a0\a0\a0\a0NO"
        }
       .ui-jqgrid .ui-jqgrid-hbox {
            padding-right: 0px;
        }
        .ui-jqgrid-htable ui-common-table
        {
                width: 973px;
                border-left: 1px solid #e1e1e1;
        }
        .headerH1 {

            margin: 8px 8px;
            font-size: 17px;
            line-height: 1.5;
            color: #337AB7;

        }
        .main-container:before {
            position: relative;
        }
        #show-no-data{
            position: relative;
            display: none;
            text-align: center;
            width: 100%;
            padding-bottom: 4%;
            color: #777;
        }
     .help-button{
         background-color: #337ab7;
     }

     .warnCont {
        text-align: left;
    }
        .mt6 {
        margin-top: 27px;
    }
     .popBox h3 {
         background: none;
    }
    .btnBar{
        position: relative;
        background: none;
    }
     .ui-jqgrid .ui-jqgrid-bdiv{
         z-index: 0;
         overflow: visible;
     }
     .prompt-class{
         padding-top: 31px;
     }

    .btn {
        padding: 6px 12px;
    }
     .popover-title{
         border-radius: 5px 5px 0 0;
         background: none;
         border-bottom: none;
     }
     .popover.left {
         margin-left: -27px;
     }
         .popover-content {
        padding: 20px 15px;
    }
     .popover-content button{
             padding: 4px 15px 4px 15px;
     }
     .tips-tbl{
         max-width: none;
     }
     .btn-blue, .btn-blue2{
         background-color: #FF6F37;
     }
    .ui-jqgrid .ui-jqgrid-htable th div{
        text-align: center;
    }
    input[type=checkbox].ace.ace-switch.ace-switch-5+.lbl::before{
        cursor: not-allowed;
    }
    </style>
    <div class="main-container box2">
        <div class="hl-help">
            <span class="linkBlue">定义产品功能</span>
        </div>
        <div class="mt20"></div>
        <table id="grid-table" >
        </table>
        <div id="show-no-data" ng-hide='{[{ visible }]}'>

            <div style="    padding: 30px 0 24px 0;">
                <a role="button" class="btn-blue" href="#/edit">立即定义产品功能</a>
            </div>
            <span id="advice-content"></span>

        </div>
        <div style="margin-top: 20px">
            <a class="headerH1" onmouseover="show_tips(this)" style="text-decoration: none;">
             <span class="help-button" data-rel="popover" data-trigger="hover" data-placement="bottom">?</span> 查看产品功能填写规则
        </a>
        </div>


        <div id="tips" style="background: #fff;display: none">

            <h1 class="headerH1">tips</h1>
            <h1 class="headerH1">1.功能序号：主要关系二进制 数据中改值所在帧结构中位置<br></h1>
            <h1 class="headerH1">2.长度：是指该功能占用的位数，单位(Bit)。1byte=8Bit<br></h1>
            <h1 class="headerH1">3.单指令帧：设备只需要传输设备功能id(序号)紧接着传该功能的的值，具体传输数据占用长度跟该功能实际占用长度保持一致<br></h1>
            <h1 class="headerH1">4.全指令帧：设备只需要按功能序号组装数据帧即可，每个功能值占用长度很配置的该功能占用长度保持一致，若传输数据和功能id(序号)对应位置不匹配，导致功能解析错乱，状态不正确</h1>
         </div>
        <div id="tip2" style="display: none;">
            <div class="prompt-class">
                <p class="headerH1" style="font-weight: bold;"><span style="font-size: 24px;">单指令：</span>单指令数据部分添加功能序号和对应状态，每次只能传递一个功能状态</p>
                <img src="/static/image/product/prompt1.jpg">
            </div>
            <div class="prompt-class">
                <p class="headerH1" style="font-weight: bold;"><span style="font-size: 24px;">多指令：</span>多指令增加功能序号和对应状态，可以交替传递多个，可交替，可多，可少</p>
                <img src="/static/image/product/prompt2.jpg">
            </div>
            <div class="prompt-class">
                <p class="headerH1" style="font-weight: bold;"><span style="font-size: 24px;">全指令：</span>全指令数据部分传输的功能状态必须和功能列表顺序保持一致，不可交叉，不接漏传</p>
                <img src="/static/image/product/prompt3.jpg">
                <img style="    position: relative;margin-left: 75%;" src="/static/image/product/tishi.png">
            </div>
        </div>

        <div id="grid-pager"></div>
        <div id="ie-form"></div>
    </div>

    <div class="popBox" id="newHtmlBox" style="display: block;z-index: 111111;text-align: center">
        <a href="javascript:;" onclick="new_close()" class="close">关闭</a>
        <h3 style="text-align: center">温馨提示</h3>
        <div class="cont mt20" style="margin-top: 20px;">
            <div class="warnCont">
                <p class="mt6">已为您定制油烟机的标准参数，如果标准参数不能满足需</p>
                <p class="mt6">求，请通过【+定义新功能】添加。申请发布需等待审核</p>
            </div>
        </div>
        <p align="center"><input type="checkbox" id="check_continueShowTips" >不再提示</p>

        <span >
            <a  href="" onclick="new_close()"  class="btn-blue" style="margin-top: 46px;">知道了</a>
        </span>

    </div>
    <!-- page specific plugin scripts -->
    <script src="/static/assets/js/jquery.jqGrid.min.js"></script>
    <script src="/static/assets/js/grid.locale-en.js"></script>
    <script src="/static/common/js/jquery.sortable.js"></script>
    <script src="/static/common/js/jquery-ui-1.10.3.custom.min.js"></script>

    <!-- inline scripts related to this page -->
    <script type="text/javascript">
        var flag = getCookie('cookie_prompt');
        $('[data-rel=popover]').popover({container:'body'});
        if(flag){
            $("#newHtmlBox").css('display','none');
            $(".markLayout").hide();
        }
        else{
            $(".markLayout").show();
        }
        function new_close() {
            var check_prompt = $("#check_continueShowTips").is(':checked');
            // 关闭的情况下，选中不再提醒
            if (check_prompt){
                setCookie('cookie_prompt', check_prompt);
            }
            $("#newHtmlBox").css('display','none');
            $(".markLayout").hide();
        }
        function setCookie(name, value) {
            var Days = 30;
            var exp = new Date();
            exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 1000);
            document.cookie = name + "=" + escape(value) + ";expires=" + exp.toGMTString()+";path=/";
        }
        //读取cookies
        function getCookie(name) {
            var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");

            if (arr = document.cookie.match(reg))

                return unescape(arr[2]);
            else
                return null;
        }
        function show_tips(obj) {
            if($("#tips").css("display") == "none"){
                $("#tips").css("display","block");
                $("#tip2").css("display","block");
            }
            else {
                $("#tips").css("display","none");
                $("#tip2").css("display","none");
            }
        }
        jQuery("#grid-table").jqGrid({
            url:location.href,
            postData:{"name": "list"},
            datatype: "json",
            mtype:"POST",
            colNames:['功能序号','功能标识', '长度', '功能名称','参数个数','是否可控', '卡片显示','显示到UI','操作'],
            colModel:[
                {name:'id' , width:107,align:'center'},
                {name:'Stream_ID', width:143},
                {name:'mxsLength',width:100,align:'center'},
                {name:'name', width:127,align:'center'},
                {name:'mxsNum', width:120,align:'center',title:false,
                    formatter:function(cellvalue, options, rowObject){
                        msg = "<option value="+rowObject.id+">"+rowObject.Stream_ID+"</option>";
                        $("#selectOpen").append(msg);
                        if(rowObject.toSwitch==1){
                            $("#selectOpen").val(rowObject.id);
                        }
                        if(cellvalue=="" || cellvalue=="0"){
                            return '<a href="#/argue" class="btn btn-white btn-xs" style="width:60px" >暂无</a>';
                        }else{
                            group = '<a class="btn btn-white btn-xs" style="width:60px" onmouseover="show_table(this)" onmouseout="hide_table(this)">'+cellvalue+'</a>';
                            group += '<div style="display: none"><table class="tips-tbl" cellspacing="0" cellpadding="0" style="z-index:9999;float: left;width: 200px;' +
                                'background: white;position: absolute;top: 45px;  border: 2px solid rgb(199, 211, 169);box-shadow:rgb(199, 211, 169) 2px 4px 6px;">'

                            group += '<thead ><tr style="height: 30px"><th >传送数据 </th><th >数据说明</th></tr></thead><tbody style="word-break: break-all;">'
                            trans_data = rowObject.mxs;
                            for(var i=0;i<trans_data.length;i++){
                                group += '<tr><td >'+trans_data[i].data+'</td><td >'+trans_data[i].desc+'</td></tr>'
                            }
                            group += '</tbody></table></div>';
                            return group;
                        }
                    }
                },
                {name:'isControl', width:108,align:'center',
                    formatter:function(cellvalue){
                        if(cellvalue=="1"){
                            return "<input name='toControl' onclick='toControl(this)' type='checkbox' class='ace ace-switch ace-switch-5' checked/><span class='lbl middle'></span>";

                        }else{
                            return "<input name='toControl' onclick='toControl(this)' type='checkbox' class='ace ace-switch ace-switch-5'/><span class='lbl middle'></span>";
                        }
                    }
                },
                {name:'isShow', width:131,align:'center',
                    formatter:function(cellvalue){
                        if(cellvalue=="1"){
                            return '<input name="isShow" onclick="checkToShow(this)" type="checkbox"  class="ace ace-switch ace-switch-5" checked/><span  class="lbl middle"></span>';

                        }else{
                            return '<input name="isShow"  onclick="checkToShow(this)" type="checkbox"  class="ace ace-switch ace-switch-5"/><span  class="lbl middle"></span>';
                        }
                    }
                },
                {name:'isDisplay', width:131,align:'center',
                    formatter:function(cellvalue){
                            if(cellvalue=="1"){
                                return '<input name="isDisplay" onclick="checkToDisplay(this)" type="checkbox" class="ace ace-switch ace-switch-5" checked/><span ng-disabled="true" class="lbl middle"></span>';

                            }else{
                                return '<input name="isDisplay"  onclick="checkToDisplay(this)" type="checkbox" class="ace ace-switch ace-switch-5"/><span ng-disabled="true" class="lbl middle"></span>';
                            }
                    }
                },
                {name:'operation', width:150,align:'center',
                    formatter:function(cellvalue, options, rowObject){
                    return "<a style='color:#337ab7'  href='#/edit?id="+rowObject.id+"' >编辑</a> | <a rel='popover' href='#/argue' id='del-info"+rowObject.id+"' onclick='del(this)' class='del-info' style='color:#337ab7'>删除</a>";
                    }
                }
            ],
            viewrecords : true,
            altRows: true,
            multiselect: false,
            multiboxonly: true,
            caption: "<a href='#/edit' ng-hide='{[{ visible }]}' class='addButton'><i  class='ace-icon glyphicon glyphicon-plus'></i>定义产品功能</a>&nbsp;&nbsp;&nbsp;&nbsp;<a onclick='export_parameter()' id='export-protocol' class='addButton'><i class='ace-icon fa fa-arrow-circle-o-down bigger-120'></i>导出控制协议</a>" +
            "<div style='float:right;margin-left:400px' ><select id='selectOpen' onchange='checkToSwitch(this)' style='color: #ff6202;'><option value=0>选择总开关</option></select><span class='help-button' data-rel='popover' data-trigger='hover' data-placement='right' data-content='选择总开关' title='' data-original-title=''>?</span></div>",

            gridComplete:function(){
                $("#grid-table").jqGrid( 'setGridWidth', $(".rightMain").width()-33 );
                $("#grid-table").jqGrid( 'setGridHeight', 'auto' );
                $(window).resize(function() {

                    $("#grid-table").jqGrid( 'setGridWidth', $(".rightMain").width()-33 );
                    $("#grid-table").jqGrid( 'setGridHeight', 'auto' );
                });

            },
            loadComplete:function (rows) {
                 $('[data-rel=popover]').popover({container:'body'});
                document.getElementById('grid-table').style.width='938px';
                tt = document.getElementsByClassName('ui-jqgrid-htable ui-common-table')[0];
                tt.style = 'border-left:1px solid #e1e1e1;width:940px;border-right:1px solid #e1e1e1;';
                if(rows.rows.length==0){
                    $("#grid-table").jqGrid( 'setGridHeight', 'auto');
                    $("#export-protocol").css('display','none');
                    $("#selectOpen").css("display",'none');
                    $("#show-no-data").css('display','block');
                    $("#advice-content").text("当前没有任何功能，选择立即定义。");
                }
                if (rows.check_state >= 1) {
                    document.getElementById("selectOpen").setAttribute('disabled','true');
                    SetDisable();
                }
                else{
                    $("#grid-table").children('tbody').sortable({
                        update: function (event, ui) {
                            var item = ui.item;
                            bootbox.confirm("确定交换两者位置?", function (result) {
                                if (result)
                                    update_id(item);
                                else
                                    $("#grid-table").children('tbody').sortable('cancel');
                            })
                        }
                    });
                }
            }
        });
        function SetDisable() {
            $("input[type=checkbox].ace.ace-switch+.lbl").css({'cursor': 'not-allowed'});
            $("input[type=checkbox].ace.ace-switch").css({'pointer-events':'none'});
            $("td a").parent().css({'cursor': 'not-allowed'});
            $("td a").css({'pointer-events':'none'});
        }
        function SendPostData(data, types) {
            $.ajax({
                url:location.href,
                type:"POST",
                data:data,
                async :false,
                success: function (data) {
                        console.log(types, "更新成功")
                    },
                error:function (data) {
                    console.log(types, "更新失败");
                }
            });
        }
        function checkToSwitch(ths) {
            id = $(ths).val();
            post_data = {'name':'toSwitch','id':id};
            SendPostData(post_data, '设置产品总开关');
        }
        function toControl(ths) {
            aa = $(ths).prop('checked');
            id = $(ths).parent().parent().attr("id");
            if(aa==false){dd=0;}
            else{dd=1;}
            post_data = {'name':'isControl','id':id,'dd':dd};
            SendPostData(post_data, '设置是否可控');
        }
        function checkToShow(ths) {
            num=0;
            id = $(ths).parent().parent().attr("id");
            var advice = "本产品最多设置3个卡片显示值";
            shows = document.getElementsByName("isShow");
            for(var i=0;i< shows.length;i++){
                if(shows[i].checked == true && id != i+1){
                    num +=1;
                }
                if (num>=3){
                    $(ths).attr('checked',false);
                    bootbox.alert(advice);
                    return;
                }
            }
            aa = $(ths).prop('checked');
            if(aa==false){dd=0;}
            else{dd=1;}
            post_data = {'name':'isShow','id':id,'dd':dd};
            SendPostData(post_data, '设置卡片显示值');
        }
        function checkToDisplay(ths) {
            id = $(ths).parent().parent().attr("id");
            aa = $(ths).prop('checked');
            if(aa==false){dd=0;}
            else{dd=1;}
            post_data = {'name':'isDisplay','id':id,'dd':dd};
            SendPostData(post_data, '设置是否显示在UI上');
        }
        function show_table(item) {
            $(item).nextAll('div').show();
            $(item).nextAll('div').children('table').show()
        }
        function hide_table(item) {
            $(item).nextAll('div').hide();
            $(item).nextAll('div').children('table').hide()
        }
        function export_parameter(){
            var rows = $("#grid-table").getRowData();
            if(rows == ''){
                bootbox.alert("暂无参数信息！");
                return;
            }
            bootbox.confirm("确定导出控制协议参数吗?", function (result) {
                if (result) {
                    var form = document.createElement('form');
                    form.action = '#/argue';
                    form.method = 'post';
                    form.style = "display: none";
                    var input = document.createElement("input");
                    input.name = "name";
                    input.type = "text";
                    input.value = "export";
                    form.appendChild(input);
                    $("#ie-form").html(form);
                    form.submit();
                }
            });
        }
        $('body').click(function (event) {
            var target = $(event.target);
            if (!target.hasClass('popover')
                    && !target.hasClass('popover-content')
                    && !target.hasClass('popover-title')
                    && !target.hasClass('arrow')
                    && !target.hasClass('del-info')
                    &&!target.hasClass('text-info')) {
                $('.del-info').popover('hide');
            }
        });
        function del(ths){
            // 选择是否删除产品功能
            id = $(ths).parent().parent().attr("id");
            $(ths).popover({
                trigger:'manual',
                placement: 'left',
                html: 'true',
                title : '<span class="text-info">确定要删除该功能点吗 ？</span>',
                content : '<button onclick="fun_close()">取消</button> <button onclick="delete_fun(\''+id +'\')" style="background-color: #337AB7;border-color: #337AB7;margin-left: 20px;color: #fff;">确认</button>'
              });
            $('.del-info').popover('hide');
            $(ths).popover('toggle');
        }
        function delete_fun(id) {
            post_data = {'name': 'del', 'id': id};
            $("#del-info" + id).popover('destroy');
            SendPostData(post_data,"删除功能");
            // 删除产品的某一功能后，该功能的后续的功能对应id和位置向前移动一位
            RePosition(id,1);
            if(isIE()){
                document.getElementById(id).removeNode(true);
            }
            else{
                document.getElementById(id).remove();
            }
        }
        function update_id(item) {
            id = item.attr("id");
            fun_name = [];
            // 重新按位置排序，并更新这一行中所有用到id的位置
            fun_name = RePosition(0,0);
            fun_name = JSON.stringify(fun_name);
            SendPostData({'name':'update','funs':fun_name}, '更新功能顺序');
        }
        function RePosition(id,index) {
            fun_name = [];
            rows = document.getElementById("grid-table").rows;
            length = rows.length;
            for (var i = 1; i <length; i++) {
                if (parseInt(id) < i) {
                    rows[i].children[0].innerText = i - index;
                    rows[i].id = i - index;
                    d_id = "del-info" + (i - index);

                    last = rows[i].children[rows[i].children.length - 1];
                    last.firstChild.href = "#/edit?id=" + (i - index);

                    last.lastChild.id = d_id;
                    fun_name.push(rows[i].children[1].title);
                }
            }
            return fun_name;
        }
        function fun_close() {
        // 关闭删除弹窗
            $('.del-info').popover('hide');
        }

    </script>