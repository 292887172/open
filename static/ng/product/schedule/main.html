<!--进度表-->
<link href="/static/bootstrap/daterangepicker/daterangepicker-bs3.css" rel="stylesheet">
<style>
    dt {
        padding: 10px;
        width: 286px;

        overflow: hidden;
    }

    .plan {
        margin: 7px 14px;
        text-align: center;
        border: 1px solid #ccc;
    }

    .plan:hover {
        border: #2fa666 1px solid;
    }

    .card {
        margin-left: 10px;
        float: left;
        position: relative;
    }

    img {
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    a {
        cursor: default;
    }

    a:hover {
        text-decoration: none;
    }

    #user_address .modal-header {
        background: #dfe6eb;
    }

    #user_address .modal-footer {
        border-radius: 0;
    }

    #user_address .modal-content {
        width: 500px;
    }

    #user_address .modal-body {
        height: 165px;
        text-align: left;
        padding-left: 20%;
    }

    #user_address .modal-body p {
        font: 16px/45px "microsoft yahei";
    }

    #user_address .modal-body p span {
        margin-left: 5px;
    }

    #user_address .modal-body p input {
        text-indent: 10px;
        border-radius: 3px;
        border: 1px solid #d9d9d9;
        width: 350px;
        line-height: 32px;
    }

    .file {
        position: relative;
        display: inline-block;
        background: #D0EEFF;
        border: 1px solid #99D3F5;
        border-radius: 4px;
        padding: 4px 12px;
        overflow: hidden;
        color: #1E88C7;
        text-decoration: none;
        text-indent: 0;
        line-height: 20px;
    }
    .delete1{
    width: 10px;
    height: 10px;
    left: 36px;
    top: -4px;
    border-radius: 15px;
    position: absolute;
    z-index: 1;
    }
    .div3{
        display: inline-block;
        width: 50px;
        height: 20px;
        margin-left:0px;
        position: relative;

    }
    .file input {
        position: absolute;
        font-size: 100px;
        right: 0;
        top: 0;
        opacity: 0;
    }
    td input{
        width: 80px;
    }
    .xxx {
        width: 170px;
        position: relative;
        display: inline-block;
        background: #D0EEFF;
        border: 1px solid #99D3F5;
        border-radius: 4px;
        padding: 4px 12px;
        overflow: hidden;
        color: #1E88C7;
        text-decoration: none;
        text-indent: 0;
        line-height: 20px;
    }

    .file:hover {
        background: #AADFFD;
        border-color: #78C3F3;
        color: #004974;
        text-decoration: none;
    }

    .disaplaied {
        pointer-events: none;
    }

    .xxxx {
        background-color: #cacaca !important;
    }
    .btn-success:hover{
       background-color: #f33000!important;
    }
    .cancelBtn{
       border: 4px solid #ddd;
    }
    button {
        border-right: 0px !important;
        border-left: 0px !important;
        border-bottom: 0px !important;
        border-top: 0px !important;
    }
    .table th{
        text-align: center;
        line-height: 2.4 !important;
    }
    .table>tbody>tr>td {
        line-height: 2.4;
        text-align: center;
    }
    .modal-label{
        display: inline-block;
        line-height: normal;
        margin-bottom: 10px;
    }
    .modal-name{
        cursor: pointer;
        max-width: 200px;
        overflow: hidden;
        -ms-text-overflow: ellipsis;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: text-bottom;
    }
    .modal-name:hover{
        color: #ff6202;
    }
    #doUpload:hover{
        background-color: #9dabbb !important;
    }
</style>

<div class="title-sub " style="text-align: center;font-size: larger">
    项目计划书

</div>
<div class="modal fade" id="user_address" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    上传文件
                </h4>
            </div>
            <div class="modal-body">

                <label for="file" class="modal-label">上传文件：<span class="modal-name">点击选择</span></label>
                <input class="file" id="file" name="file" style="display: none" type="file"/>
                <div style="overflow: hidden;">
                    <span>备注信息：</span><input type="text" id="ui_info" class="xxx" placeholder="备注信息">
                </div>
                <div style="text-align: center;margin-left: -20%;margin-top: 10px">
                    <button id="doUpload" class="btn btn-info" onclick="doUploadFile()"
                        style="width:80px;height:30px;padding-bottom: 0px;padding-top: 0px">
                    上传
                </button>
                </div>

            </div>


        </div>
    </div>
</div>
<table class="table table-bordered ">
    <thead>
    <tr>
        <th style="width: 50px">序号</th>
        <th style="width: 100px!important;text-align: center">负责方</th>
        <th style="width: 174px;text-align: center">任务</th>
        <th style="text-align: center">时间</th>
        <th style="width: 200px;text-align: center">操作</th>
        <th style="text-align: center">确认(不可更改)</th>
        <th style="text-align: center">备注</th>
    </tr>
    </thead>
    <tbody >
    <tr>
        <th scope="row">1</th>
        <td><input type="text" onblur="Blur(0,1,this)"></td>
        <td>提交详细技术功能规划书</td>
        <td><input type="text" placeholder="请选择日期" onclick="Change(1,this)" class="form-control pull-right"
                   id="reservation-1"/>
        </td>
        <td>
            <button  type="button" class="" data-toggle="modal" style="background: white" data-target="#user_address"
                    onclick="xxx(1)">上传
            </button><div ><a ></a></div>

        </td>
        <td>
            <button type="button" class="btn" style="background-color: blue" onclick="confirm(1)">确认</button>
        </td>
        <td><input type="text" onblur="Blur(2,1,this)"></td>
    </tr>
    <tr>
        <th scope="row">2</th>
        <td><input type="text" onblur="Blur(0,2,this)"></td>
        <td>提交电控板功能协议文档</td>
        <td><input type="text" placeholder="请选择日期" onclick="Change(2,this)" class="form-control pull-right"
                   id="reservation-2"/></td>
        <td>
            <button id="xx" type="button" class="" style="background: white" data-toggle="modal" data-target="#user_address"
                    onclick="xxx(2)">上传
            </button><div ><a href=""></a></div>
        </td>
        <td>
            <button type="button" class="btn" style="background-color: blue" onclick="confirm(2)">确认</button>
        </td>
        <td><input type="text" onblur="Blur(2,2,this)"></td>
    </tr>
    <tr>
        <th scope="row">3</th>
        <td><input type="text" onblur="Blur(0,3,this)"></td>
        <td>提交正式UI和UE</td>
        <td>
            <input type="text" placeholder="请选择日期" onclick="Change(3,this)" class="form-control pull-right"
                   id="reservation-3"/>
        </td>
        <td>
            <button type="button" class="" data-toggle="modal" data-target="#user_address"
                    onclick="xxx(3)" style="background: white">上传
            </button><div><a href=""></a></div>
        </td>
        <td>
            <button type="button" class="btn" style="background-color: blue" onclick="confirm(3)">确认</button>
        </td>
        <td><input type="text" onblur="Blur(2,3,this)"></td>
    </tr>
    <tr>
        <th scope="row">4</th>
        <td><input type="text" onblur="Blur(0,4,this)"></td>
        <td>制定项目进度计划书</td>
        <td>
            <input type="text" placeholder="请选择日期" onclick="Change(4,this)" class="form-control pull-right"
                   id="reservation-4"/>
        </td>
        <td>
            <button type="button" class="" data-toggle="modal" data-target="#user_address"
                    onclick="xxx(4)" style="background: white">上传
            </button><div><a href=""></a></div>
        </td>
        <td>
            <button type="button" class="btn" style="background-color: blue" onclick="confirm(4)">确认</button>
        </td>
        <td><input type="text" onblur="Blur(2,4,this)"></td>
    </tr>
    <tr>
        <th scope="row">5</th>
        <td><input type="text" onblur="Blur(0,5,this)"></td>
        <td>应用程序开发</td>
        <td>
            <input type="text" placeholder="请选择日期" onclick="Change(5,this)" class="form-control pull-right"
                   id="reservation-5"/>
        </td>
        <td>
            <button type="button" class="" data-toggle="modal" data-target="#user_address"
                    onclick="xxx(5)" style="background: white">上传
            </button><div><a href=""></a></div>
        </td>
        <td>
            <button type="button" class="btn" style="background-color: blue" onclick="confirm(5)">确认</button>
        </td>
        <td><input type="text" onblur="Blur(2,5,this)"></td>
    </tr>
    <tr>
        <th scope="row">6</th>
        <td><input type="text" onblur="Blur(0,6,this)"></td>
        <td>提供正式电控版</td>
        <td>
            <input type="text" placeholder="请选择日期" onclick="Change(6,this)" class="form-control pull-right"
                   id="reservation-6"/>
        </td>
        <td>
            <button type="button" class="" data-toggle="modal" data-target="#user_address"
                    onclick="xxx(6)" style="background: white">上传
            </button><div><a href=""></a></div>
        </td>
        <td>
            <button type="button" class="btn" style="background-color: blue" onclick="confirm(6)">确认</button>
        </td>
        <td><input type="text" onblur="Blur(2,6,this)"></td>
    </tr>
    <tr>
        <th scope="row">7</th>
        <td><input type="text" onblur="Blur(0,7,this)"></td>
        <td>控制协议对接</td>
        <td>
            <input type="text" placeholder="请选择日期" onclick="Change(7,this)" class="form-control pull-right"
                   id="reservation-7"/>
        </td>
        <td >
            <button type="button" class="" data-toggle="modal" data-target="#user_address"
                    onclick="xxx(7)" style="background: white">上传
            </button><div></div>
        </td>
        <td>
            <button type="button" class="btn" style="background-color: blue" onclick="confirm(7)">确认</button>
        </td>
        <td><input type="text" onblur="Blur(2,7,this)"></td>
    </tr>
    <tr>
        <th scope="row">8</th>
        <td><input type="text" onblur="Blur(0,8,this)"></td>
        <td>提供整机</td>
        <td>
            <input type="text" placeholder="请选择日期" onclick="Change(8,this)" class="form-control pull-right"
                   id="reservation-8"/>
        </td>
        <td>
            <button type="button" class="" data-toggle="modal" data-target="#user_address"
                    onclick="xxx(8)" style="background: white">上传
            </button><div><a href=""></a></div>
        </td>
        <td>
            <button type="button" class="btn" style="background-color: blue" onclick="confirm(8)">确认</button>
        </td>
        <td><input type="text" onblur="Blur(2,8,this)"></td>
    </tr>
    <tr>
        <th scope="row">9</th>
        <td><input type="text" onblur="Blur(0,9,this)"></td>
        <td>整机联调、老化测试</td>
        <td>
            <input type="text" placeholder="请选择日期" onclick="Change(9,this)" class="form-control pull-right"
                   id="reservation-9"/>
        </td>
        <td>
            <button type="button" class="" data-toggle="modal" data-target="#user_address"
                    onclick="xxx(9)" style="background: white">上传
            </button><div><a href=""></a></div>
        </td>
        <td>
            <button type="button" class="btn" style="background-color: blue"  onclick="confirm(9)">确认</button>
        </td>
        <td><input type="text" onblur="Blur(2,9,this)"></td>
    </tr>
    </tbody>
</table>
<div style="display: none">
    <input type="text" value="" id="get_value">
    <input type="text" value="" id="get_remarks">
    <input type="text" value="" id="get_time_stemp">
</div>


<script>
    $('.pull-right').daterangepicker();
    $.ajax({
        url: '/product/schedule',
        type: "GET",
        data: {"key": keysss}
    }).success(function (data) {
        data = JSON.parse(data)
        //console.log('长度',data)
        for (var i = 0, lent = data.length; i < lent; i++) {
            //url 处理
            var list = data[i]['url'];
            // 长度判断
            try {
                 if (list[0].length > 0) {

                for (var ti = 0; ti < list.length; ti++) {
                    //console.log(ttt[ti].split("'")[1])
                    var new_url = list[ti];
                    var ty = document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[3].querySelector("div")

                    var p = new_url.substring(new_url.length - 6)
                    $(ty).after("<div class=\"div3\"><img title=\"删除\" src=\"/static/image/product/delete.png\" class=\"delete1\" alt=\"\" onclick=\"Deleted(this,"+ data[i]['id'] +")\"><a href='" + new_url + "'style=\"display: inline-block\" >" + p + "</a>&nbsp;&nbsp;</div>")
                }
            }
            }
            catch (err) {
                 if (list.length > 0) {

                for (var ti = 0; ti < list.length; ti++) {
                    //console.log(ttt[ti].split("'")[1])
                    var new_url = list[ti];
                    var ty = document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[3].querySelector("div")

                    var p = new_url.substring(new_url.length - 6)
                    $(ty).after("<div class=\"div3\"><img title=\"删除\" src=\"/static/image/product/delete.png\" class=\"delete1\" alt=\"\" onclick=\"Deleted(this,"+ data[i]['id'] +")\"><a href='" + new_url + "'style=\"display: inline-block\" >" + p + "</a>&nbsp;&nbsp;</div>")
                }
            }
            }


            if (data[i]['ack'] == 1) {
                document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[0].classList.add("disaplaied");
                document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[2].classList.add("disaplaied");
                document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[3].querySelectorAll("button")[0].classList.add("disaplaied");
                document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[4].classList.add("disaplaied");
                document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[4].querySelectorAll("button")[0].innerText="已确认";
                document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[4].querySelectorAll("button")[0].classList.add("xxxx");

            }
            if (data[i]['time_stemp']) {
                document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[2].querySelector("input").value = data[i]['time_stemp']
            }
            if (data[i]['remark']){
                document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[5].querySelector("input").value = data[i]['remark']
            }
            if (data[i]['party']){
                document.querySelector(".table").querySelectorAll("tr")[data[i]['id']].querySelectorAll("td")[0].querySelector("input").value = data[i]['party']
            }
        }

    })
    function Deleted(c,b) {
        var del_url = c.parentNode.getElementsByTagName("a")[0].href
       $.ajax({
           url: '/product/schedule',
           type:"POST",
           data:{"key":keysss,"action":"del","del_id":b,"del_url":del_url}
       }).success(function (data) {
           data = JSON.parse(data)
           if (data['code']===0){
               alert("删除成功")
           //window.location.reload()
           }else{
               alert("删除失败")
           }

       })
    }
    function Change(c,that) {

         setTimeout(function () {
                           funce(c,that)
                        }, 4000)
    }
    function funce(c,that) {
        var time_stemp = document.querySelector(".table").querySelectorAll("tr")[c].querySelectorAll("td")[2].querySelector("input").value
        $.ajax({
             type:"POST",
             url:'/product/schedule',
             data:{'key':keysss,"action":"time_strmp","value":time_stemp,"id":c}
        }).success(function (data) {
            data = JSON.parse(data)
            if (data['code']===0){
                console.log('success')
                document.querySelector(".table").querySelectorAll("tr")[c].querySelectorAll("td")[2].querySelector("input").value =time_stemp;
            }else {
                console.log('error')
            }


        })
    }
    function Blur(a,b,c) {
        var t = c.value
        if (a===2){

            // 备注信息
            $.ajax({
                    type:"POST",
                    url:'/product/schedule',
                    data:{'key':keysss,"action":"remark","value":t,"id":b}
                }).success(function (data) {
                    data = JSON.parse(data)
                    if (data['code']===0){
                        console.log('success')
                        document.querySelector(".table").querySelectorAll("tr")[b].querySelectorAll("td")[5].querySelector("input").value = t;
                    }else {
                        console.log('error')

                    }


                })

        }
        else if (a===0){

            // 责任方
            $.ajax({
                    type:"POST",
                    url:'/product/schedule',
                    data:{'key':keysss,"action":"party","value":t,"id":b}
                }).success(function (data) {
                    data = JSON.parse(data)
                    if (data['code']===0){
                        console.log('success')
                        document.querySelector(".table").querySelectorAll("tr")[b].querySelectorAll("td")[0].querySelector("input").value = t;

                    }else {
                        console.log('error')
                    }

                })

        }


    }
    function confirm(that) {

        var thref = location.href
        $.ajax({
            url: '/product/schedule',
            type: "POST",
            data: {"num": that, "key": keysss, "location": thref},
        }).success(function (data) {
            // code 判断
            alert('保存成功，已通知下一环节处理人员');
            document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[0].classList.add("disaplaied");
            document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[2].classList.add("disaplaied");
            document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[4].classList.add("disaplaied");
            var t = document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[4].innerText="已确认";

        })
    }
    function xxx(that) {
        document.getElementById("get_value").value = that;
        //document.getElementById("get_remarks").value = document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[3].querySelector("input").value
    }
    function doUploadFile() {
        // 时间戳
        var id = document.getElementById("get_value").value
        var time_stemp = document.querySelector(".table").querySelectorAll("tr")[id].querySelectorAll("td")[2].querySelectorAll("input")[0].value;
        var idd = document.getElementById("get_value").value
        var formData = new FormData();
        formData.append("file", document.getElementById("file").files[0]);
        formData.append("name", 'upload');
        formData.append("key", keysss);
        formData.append("id", idd);
        formData.append("ui_info", document.getElementById("ui_info").value);
        formData.append("ui_time_stemp", time_stemp);
        var thref = location.href
        formData.append("location", thref);

        if (document.getElementById("file").files[0]) {
            $.ajax({
                url: '/product/upload_file',
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
            }).success(function (data) {
                data = JSON.parse(data)
                if (data['code'] == 0) {




                    document.getElementsByClassName("close")[0].click();
                    window.location.reload()
                    bootbox.alert('上传成功')
                } else {
                    document.getElementsByClassName("close")[0].click();
                    bootbox.alert('上传失败')
                }


            })
        } else {
            bootbox.alert('不能为空')
        }
    }

    var upto_file = $("#file");
    var upto_text = $(".modal-name");
    upto_file.on('change',function (e) {
        let upto_name = e.currentTarget.files[0].name;
        upto_text.text(upto_name);
        upto_text.attr('title',upto_name);
    })
</script>



