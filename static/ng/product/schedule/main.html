<!--进度表-->
<link href="/static/bootstrap/daterangepicker/daterangepicker-bs3.css" rel="stylesheet">
<style>
    dt {
        padding: 10px;
        width: 286px;

        overflow: hidden;
    }

    .plan {
        margin: 7px 14px;
        text-align: center;
        border: 1px solid #ccc;
    }

    .plan:hover {
        border: #2fa666 1px solid;
    }

    .card {
        margin-left: 10px;
        float: left;
        position: relative;
    }

    img {
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    a {
        cursor: default;
    }

    a:hover {
        text-decoration: none;
    }

    #user_address .modal-header {
        background: #dfe6eb;
    }

    #user_address .modal-footer {
        border-radius: 0;
    }

    #user_address .modal-content {
        width: 500px;
    }

    #user_address .modal-body {
        height: 165px;
        text-align: left;
        padding-left: 20%;
    }

    #user_address .modal-body p {
        font: 16px/45px "microsoft yahei";
    }

    #user_address .modal-body p span {
        margin-left: 5px;
    }

    #user_address .modal-body p input {
        text-indent: 10px;
        border-radius: 3px;
        border: 1px solid #d9d9d9;
        width: 350px;
        line-height: 32px;
    }

    .file {
        position: relative;
        display: inline-block;
        background: #D0EEFF;
        border: 1px solid #99D3F5;
        border-radius: 4px;
        padding: 4px 12px;
        overflow: hidden;
        color: #1E88C7;
        text-decoration: none;
        text-indent: 0;
        line-height: 20px;
    }
    .delete1{
    width: 10px;
    height: 10px;
    left: 42px;
    top: -5px;
    border-radius: 15px;
    position: absolute;
    z-index: 1;
    }
    .div3{
        display: inline-block;
        width: 50px;
        height: auto;
        margin-left:0px;
        position: relative;
        font-size: 0;
    }
    .div3 a{
        font-size: 14px;
    }
    .file input {
        position: absolute;
        font-size: 100px;
        right: 0;
        top: 0;
        opacity: 0;
    }
    td input{
        width: 80px;
    }
    .xxx {
        width: 170px;
        position: relative;
        display: inline-block;
        background: #D0EEFF;
        border: 1px solid #99D3F5;
        border-radius: 4px;
        padding: 4px 12px;
        overflow: hidden;
        color: #1E88C7;
        text-decoration: none;
        text-indent: 0;
        line-height: 20px;
    }

    .file:hover {
        background: #AADFFD;
        border-color: #78C3F3;
        color: #004974;
        text-decoration: none;
    }

    .disaplaied {
        pointer-events: none;
    }

    .xxxx {
        background-color: #cacaca !important;
    }
    .btn-success:hover{
       background-color: #f33000!important;
    }
    .cancelBtn{
       border: 4px solid #ddd;
    }
    button {
        border-right: 0px !important;
        border-left: 0px !important;
        border-bottom: 0px !important;
        border-top: 0px !important;
    }
    .table th{
        text-align: center;
        line-height: 2.4 !important;
    }
    .table>tbody>tr>td {
        line-height: 2.4;
        text-align: center;
    }
    .modal-label{
        display: inline-block;
        line-height: normal;
        margin-bottom: 10px;
    }
    .modal-name{
        cursor: pointer;
        max-width: 200px;
        overflow: hidden;
        -ms-text-overflow: ellipsis;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        vertical-align: text-bottom;
    }
    .modal-name:hover{
        color: #ff6202;
    }
    #doUpload:hover{
        background-color: #9dabbb !important;
    }
    .my_container{
        position: relative;
        display: none;
        text-align: left;
        width: 100%;
        height: 15px;
        background-color: gray;
    }
    #progress{
        text-align: center;
        font-size: 12px;
        line-height: 1;
        height: 15px;
        background-color: orange;
        display: inline-block;
    }
    #progress-text{
        position: absolute;
        display: block;
        margin: 0 auto;
        text-align: center;
        left: 0;
        right: 0;
        top: 0;
        font-size: 12px;
        line-height: 1;
    }
    .hide1{
        display: none;
    }
    .div3 span{
        font-size: 14px;
        line-height: 2;
    }
</style>

<div class="title-sub " style="text-align: center;font-size: larger">
    项目计划书
    <button type="button" class="btn btn-success" style="float: right;margin-right: 20px;margin-bottom:10px;" onclick="Add() ">新增计划</button>
    <button type="button" class="btn btn-success" style="float: right;margin-right: 20px;margin-bottom:10px;display: none" onclick="Show()">编辑</button>
    <button type="button" class="btn btn-success" style="float: right;margin-right: 20px;margin-bottom:10px;display: none" onclick="Setting()">合并</button>
</div>
<div class="modal fade" id="user_address" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    上传文件
                </h4>
            </div>
            <div class="my_container">
                <span id="progress"></span>
                <span id="progress-text">等待上传</span>
            </div>
            <div class="modal-body">

                <label for="file" class="modal-label">上传文件：<span class="modal-name">点击选择</span></label>
                <input class="file" id="file" name="file" style="display: none" type="file"/>
                <div style="overflow: hidden;">
                    <span>备注信息：</span><input type="text" id="ui_info" class="xxx" placeholder="备注信息">
                </div>
                <div style="text-align: center;margin-left: -20%;margin-top: 10px">
                    <button id="doUpload" class="btn btn-info" onclick="doUploadFile()"
                        style="width:80px;height:30px;padding-bottom: 0px;padding-top: 0px">
                    上传
                </button>
                </div>

            </div>


        </div>
    </div>
</div>
<table class="table table-bordered all_setting" ng-app="Product.protocol" ng-controller="PortalCtrl">
    <thead>
    <tr>

        <th style="width: 50px">序</th>
        <th style="width: 100px!important;text-align: center">负责方</th>
        <th style="width: 174px;text-align: center">任务</th>
        <th style="text-align: center">时间</th>
        <th style="width: 200px;text-align: center">上传下载</th>
        <th style="width: 100px;text-align: center">确认</th>
        <th style="text-align: center">备注</th>
        <th style="text-align: center">操作</th>
    </tr>
    </thead>
    <tbody >
    <tr ng-repeat="x in response" >
        <th style="font-family: 黑体" >{[{x.id}]}</th>
        <td ng-if="x.ack==1"><input type="text"  value="{[{x.party}]}" data="{[{x.id}]}" onblur="Blur(0,this)" disabled></td>
        <td ng-if="x.ack==0"><input type="text" value="{[{x.party}]}" data="{[{x.id}]}" onblur="Blur(0,this)"></td>
        <td ng-if="x.ack==1"><input value="{[{x.plan}]}" disabled class="x3x" data="{[{x.id}]}" onblur='Blur(1,this)' type="text" style="width: 180px"></td>
        <td ng-if="x.ack==0"><input value="{[{x.plan}]}" class="x3x" data="{[{x.id}]}" onblur='Blur(1,this)' type="text" style="width: 180px"></td>
        <td ng-if="x.ack==1"><input type="text" disabled placeholder="请选择日期" data="{[{x.id}]}" value="{[{x.time_stemp}]}" onclick="Change(this)" class="form-control pull-right" id="reservation-1"/></td>
        <td ng-if="x.ack==0"><input type="text" placeholder="请选择日期" data="{[{x.id}]}" value="{[{x.time_stemp}]}" onclick="Change(this)" class="form-control pull-right" id="reservation-1"/></td>
        <td >
            <button ng-if="x.ack==1" disabled type="button" class="" data="{[{x.id}]}" data-toggle="modal" style="background: white" data-target="#user_address"
                    onclick="xxx(this)">上传
            </button>
            <button ng-if="x.ack==0" type="button" class="" data="{[{x.id}]}" data-toggle="modal" style="background: white" data-target="#user_address"
                    onclick="xxx(this)">上传
            </button>

                <div ng-repeat="c in x.url" ng-if="c" class="div3"><img title="删除" src="/static/image/product/delete.png" data="{[{x.id}]}"  class="delete1" alt="" onclick="Deleted(this)"><a href="{[{c}]}">{[{c.substring(c.length-6)}]}</a></div>



        </td>
        <td ng-if="x.ack==1">
            <button type="button" class="btn" data="{[{x.id}]}" disabled onclick="confirm(this)">已确认</button>
        </td>
        <td ng-if="x.ack==0">
            <button type="button" class="btn" data="{[{x.id}]}" style="background-color: blue" onclick="confirm(this)">确认</button>
        </td>
        <td><input type="text" data="{[{x.id}]}" value="{[{x.remark}]}" onblur="Blur(2,this)"></td>
        <td><button class="btn " data="{[{x.id}]}" onclick="Del(this)">删除</button></td>
    </tr>

    </tbody>
</table>
<div style="display: none">
    <input type="text" value="" id="get_value">
    <input type="text" value="" id="get_values">
    <input type="text" value="" id="get_remarks">
    <input type="text" value="" id="get_time_stemp">
</div>


<script>
    $('.pull-right').daterangepicker();
    function Del(that) {
        var id = that.attributes['data'].nodeValue
        $.ajax({
           url: '/product/schedule',
           type:"POST",
           data:{"key":keysss,"action":"delxu","del_id":id}
       }).success(function (data) {
              data = JSON.parse(data)
           if (data['code']===0){
               bootbox.alert("删除成功")
               window.location.reload()
           }else{
               bootbox.alert("删除失败")
           }

        })
    }
    function Show() {
        var t = document.getElementsByClassName("hide1")
        for (var i =0,t_l = t.length;i<t_l;i++){

            console.log(t[i])
        }
    }
    function Deleted(c) {
        console.log(c)
        var del_url = c.parentNode.getElementsByTagName("a")[0].href
        var b = c.attributes['data'].nodeValue
        console.log('xxx',del_url,b)
       $.ajax({
           url: '/product/schedule',
           type:"POST",
           data:{"key":keysss,"action":"del","del_id":b,"del_url":del_url}
       }).success(function (data) {
           data = JSON.parse(data)
           if (data['code']===0){
               bootbox.alert("删除成功")
               window.location.reload()
           }else{
               bootbox.alert("删除失败")
           }

       })
    }
    function Change(that) {
        that = that.attributes['data'].nodeValue
        document.getElementById("get_values").value = that
    }
    window.onload = function(){
        $('.pull-right').daterangepicker();
        $(".applyBtn").on("click",function () {
        var c = document.getElementById("get_values").value
         setTimeout(function () {
                           funce(c)
                        }, 500)
    })
    }

    function funce(c) {
        console.log(c)
         var time_stemp = document.querySelector(".table").querySelectorAll("tr")[c].querySelectorAll("td")[2].querySelector("input").value
         console.log(time_stemp)
        $.ajax({
             type:"POST",
             url:'/product/schedule',
             data:{'key':keysss,"action":"time_strmp","value":time_stemp,"id":c}
        }).success(function (data) {
            data = JSON.parse(data)
            if (data['code']===0){
                console.log('success')
                document.querySelector(".table").querySelectorAll("tr")[c].querySelectorAll("td")[2].querySelector("input").value =time_stemp;
            }else {
                console.log('error')
            }


        })
    }
    function Blur(a,c) {
        var b = c.attributes['data'].nodeValue
        var t = c.value
        if (a===2){

            // 备注信息
            $.ajax({
                    type:"POST",
                    url:'/product/schedule',
                    data:{'key':keysss,"action":"remark","value":t,"id":b}
                }).success(function (data) {
                    data = JSON.parse(data)
                    if (data['code']===0){
                        console.log('success')
                        document.querySelector(".table").querySelectorAll("tr")[b].querySelectorAll("td")[5].querySelector("input").value = t;
                    }else {
                        console.log('error')

                    }


                })

        }
        else if (a===0){

            // 责任方
            $.ajax({
                    type:"POST",
                    url:'/product/schedule',
                    data:{'key':keysss,"action":"party","value":t,"id":b}
                }).success(function (data) {
                    data = JSON.parse(data)
                    if (data['code']===0){
                        console.log('success')
                        document.querySelector(".table").querySelectorAll("tr")[b].querySelectorAll("td")[0].querySelector("input").value = t;

                    }else {
                        console.log('error')
                    }

                })

        }
        else if (a===1){

           // 责任方
            $.ajax({
                    type:"POST",
                    url:'/product/schedule',
                    data:{'key':keysss,"action":"plan","value":t,"id":b}
                }).success(function (data) {
                    data = JSON.parse(data)
                    if (data['code']===0){
                        console.log('success')
                        document.querySelector(".table").querySelectorAll("tr")[b].querySelectorAll("td")[1].querySelector("input").value = t;

                    }else {
                        console.log('error')
                    }

                })

        }


    }
    function confirm(that) {
        that = that.attributes['data'].nodeValue
        var thref = location.href
        $.ajax({
            url: '/product/schedule',
            type: "POST",
            data: {"num": that, "key": keysss, "location": thref},
        }).success(function (data) {
            // code 判断
            bootbox.alert('保存成功，已通知下一环节处理人员');
            document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[0].classList.add("disaplaied");
            document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[2].classList.add("disaplaied");
            document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[4].classList.add("disaplaied");
            var t = document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[4].innerText="已确认";

        })
    }
    function xxx(that) {
        that = that.attributes['data'].nodeValue
        console.log(that)
        document.getElementById("get_value").value = that;
        //document.getElementById("get_remarks").value = document.querySelector(".table").querySelectorAll("tr")[that].querySelectorAll("td")[3].querySelector("input").value
    }
    function xxxx(that) {
         document.getElementById("get_value").value = that;
    }
    function doUploadFile() {
        // 时间戳
        var id = document.getElementById("get_value").value
        var time_stemp = document.querySelector(".table").querySelectorAll("tr")[id].querySelectorAll("td")[2].querySelectorAll("input")[0].value;
        var idd = document.getElementById("get_value").value
        var formData = new FormData();
        formData.append("file", document.getElementById("file").files[0]);
        formData.append("name", 'upload');
        formData.append("key", keysss);
        formData.append("id", idd);
        formData.append("ui_info", document.getElementById("ui_info").value);
        formData.append("ui_time_stemp", time_stemp);
        var thref = location.href
        formData.append("location", thref);

        if (document.getElementById("file").files[0]) {
            $.ajax({
                url: '/product/upload_file',
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                xhr:function () {
                    console.log("开始上传")
                  var myXhr = $.ajaxSettings.xhr();
                  if(myXhr.upload){
                    myXhr.upload.addEventListener('progress',progressHandlingFunction, false)
                  }
                  return myXhr
                },
            }).success(function (data) {
                console.log("上传成功")
                data = JSON.parse(data)
                if (data['code'] == 0) {
                    document.getElementsByClassName("close")[0].click();
                    window.location.reload()
                    bootbox.alert('上传成功')
                } else {
                    document.getElementsByClassName("close")[0].click();
                    bootbox.alert('上传失败，文件格式不支持')
                }
            })
        } else {
            bootbox.alert('不能为空')
        }
    }
    function progressHandlingFunction(e){
        if(e.lengthComputable){
            var percent = e.loaded/e.total*100;
            let my_precent_data = percent.toFixed(2);
            if (my_precent_data >99){
                my_precent_data = 99
            }
            $('#progress-text').html(my_precent_data + "%");
            $('#progress').css('width', my_precent_data + "%");
        }
    }

    var upto_file = $("#file");
    var upto_text = $(".modal-name");
    upto_file.on('change',function (e) {
        let upto_name = e.currentTarget.files[0].name;
        upto_text.text(upto_name);
        upto_text.attr('title',upto_name);
        $(".my_container").slideDown();
    })

    function Add() {
        var tables = $('.table');
        var row = document.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        var leng = row.length + 1
        var addtr = $("<tr>" +
        "<th scope=\"row\">"+leng + "</th>"+
        "<td><input type=\"text\" data=\""+leng+"\" onblur=\"Blur(0,this)\"></td>"+
        "<td><input value=\"\" type=\"text\" data=\""+leng+"\" onblur=\"Blur(1,this)\" style=\"width: 180px\"></td>"+
        "<td><input type=\"text\" data=\""+leng+"\" placeholder=\"请选择日期\" onclick=\"Change(this)\" class=\"form-control pull-right\" id=\"reservation-"+leng+"\"/></td>"+
        "<td><button type=\"button\" data=\""+leng+"\" class=\"\" data-toggle=\"modal\" data-target=\"#user_address\" onclick=\"xxxx(this)\" style=\"background: white\">上传 </button><div><a href=\"\"></a></div></td>"+
        "<td><button type=\"button\" data=\""+leng+"\" class=\"btn\" style=\"background-color: blue\"  onclick=\"confirm(this)\">确认</button></td>"+
        "<td><input type=\"text\" data=\""+leng+"\" onblur=\"Blur(2,this)\"></td>"+
        "<td><button class=\"btn \" data=\""+leng+"\" onclick=\"Del(this)\">删除</button></td>"+
        "</tr>");

        addtr.appendTo(tables);
        $('.pull-right').daterangepicker();
    }

    $(".applyBtn").on("click",function () {
        var c = document.getElementById("get_values").value;
         setTimeout(function () {
                           funce(c)
                        }, 500)
    })

    function a_download(val){
        let myUrl = val.getAttribute("data-downurl");
        var $a = document.createElement('a');
        $a.setAttribute("href", myUrl);
        $a.setAttribute("download", "");

        var evObj = document.createEvent('MouseEvents');
        evObj.initMouseEvent( 'click', true, true, window, 0, 0, 0, 0, 0, false, false, true, false, 0, null);
        $a.dispatchEvent(evObj);
    }

</script>



